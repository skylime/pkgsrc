#!@SH@
# $NetBSD: scan-client-start,v 1.7 2016/12/18 22:59:35 joerg Exp $

. @PBULK_CONFIG@

set -e

# Support older configs which used scan_chroots
scan_procs=${scan_procs:-${scan_chroots:-1}}

if [ "${config_version}" != "@PBULK_CONFIG_VERSION@" ]; then
	echo "Your configuration has version ${config_version}."
	echo "This version of pbulk expects version @PBULK_CONFIG_VERSION@."
	exit 1
fi

if [ -f "${bulklog}.old/meta/pscan" ]; then
	extra_pscan_args="-L ${bulklog}.old/meta/pscan"
else
	extra_pscan_args=""
fi

${client_prepare}

for client in ${scan_clients}; do
	case ${client} in
	/*)
		path=${client}
		port=
		client=
		;;
	*:*)
		path=
		port="-p ${client##*:}"
		client=${client%%:*}
		;;
	*)
		path=
		port=
		;;
	esac
	if [ -z "$path" ]; then
		if [ -n "${chroot_create}" -a "${chroot_dir}" ]; then
			ssh $port $client "
				i=1
				while true; do
					PBULK_CONF=${PBULK_CONF} chroot ${chroot_dir}-scan @SH@ -c \"${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc}\" &
					i=\$((i + 1))
					if [ \$i -gt ${scan_procs} ]; then
						break
					fi
				done" &
		else
			ssh $port $client "PBULK_CONF=${PBULK_CONF} ${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc}" &
		fi
	else
		i=1
		while true; do
			chroot "$path" ${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc} &
			i=$((i + 1))
			if [ $i -gt ${scan_procs} ]; then
				break
			fi
		done
	fi
done
